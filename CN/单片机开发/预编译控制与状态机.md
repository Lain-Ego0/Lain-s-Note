在STM32嵌入式开发里，`#ifndef`、`#define`和`#endif`这些预编译控制语句在状态机控制方面发挥着极为关键的作用。

### 避免头文件重复包含
在STM32项目里，通常会有很多头文件，并且这些头文件可能会被多个源文件包含。若没有合适的预防措施，就会引发重复定义的错误。借助`#ifndef`、`#define`和`#endif`能够保证头文件仅被包含一次，从而避免这类错误。

```c
// state_machine.h
#ifndef STATE_MACHINE_H
#define STATE_MACHINE_H

// 状态机相关的结构体和函数声明
typedef enum {
    STATE_IDLE,
    STATE_WORKING,
    STATE_ERROR
} StateMachineState;

void state_machine_init(void);
void state_machine_update(StateMachineState new_state);

#endif
```

### 定义状态常量
在状态机控制中，需要定义不同的状态常量来代表状态机的各个状态。利用`#define`可以方便地定义这些常量，并且使用`#ifndef`和`#endif`确保它们只被定义一次。

```c
// states.h
#ifndef STATES_H
#define STATES_H

#define STATE_START 0
#define STATE_READ_SENSOR 1
#define STATE_PROCESS_DATA 2
#define STATE_SEND_RESULT 3
#define STATE_END 4

#endif
```

### 条件编译实现不同功能
STM32开发中，可能要依据不同的硬件平台或者配置来实现不同的状态机逻辑。借助`#ifndef`、`#define`和`#endif`进行条件编译，能够依据不同的宏定义来选择不同的状态机逻辑。

```c
// state_machine_config.h
#ifndef STATE_MACHINE_CONFIG_H
#define STATE_MACHINE_CONFIG_H

// 根据不同的硬件平台选择不同的配置
#ifdef STM32F4XX
#define USE_HIGH_SPEED_MODE
#endif

#endif

// state_machine.c
#include "state_machine_config.h"
#include "states.h"

void state_machine_run(int current_state) {
    #ifdef USE_HIGH_SPEED_MODE
        // 高速模式下的状态机逻辑
        switch (current_state) {
            case STATE_START:
                // 高速启动逻辑
                break;
            case STATE_READ_SENSOR:
                // 高速读取传感器逻辑
                break;
            case STATE_PROCESS_DATA:
                // 高速数据处理逻辑
                break;
            case STATE_SEND_RESULT:
                // 高速发送结果逻辑
                break;
            case STATE_END:
                // 高速结束逻辑
                break;
            default:
                break;
        }
    #else
        // 普通模式下的状态机逻辑
        switch (current_state) {
            case STATE_START:
                // 普通启动逻辑
                break;
            case STATE_READ_SENSOR:
                // 普通读取传感器逻辑
                break;
            case STATE_PROCESS_DATA:
                // 普通数据处理逻辑
                break;
            case STATE_SEND_RESULT:
                // 普通发送结果逻辑
                break;
            case STATE_END:
                // 普通结束逻辑
                break;
            default:
                break;
        }
    #endif
}
```
